{% extends "admin/base_admin.html" %}

{% block title %}Activity Logs - Admin Panel{% endblock %}

{% block page_title %}Activity & System Logs{% endblock %}
{% block page_icon %}history{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Activity Logs</li>
{% endblock %}

{% block extra_css %}
<style>
    .timeline {
        position: relative;
        padding: 20px 0;
    }

    .timeline-item {
        position: relative;
        padding-left: 60px;
        margin-bottom: 30px;
    }

    .timeline-item:before {
        content: '';
        position: absolute;
        left: 24px;
        top: 0;
        bottom: -30px;
        width: 2px;
        background: #e9ecef;
    }

    .timeline-item:last-child:before {
        display: none;
    }

    .timeline-icon {
        position: absolute;
        left: 0;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        z-index: 1;
    }

    .timeline-content {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .log-level {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .log-level-info { background: #e0f2fe; color: #0369a1; }
    .log-level-warning { background: #fef3c7; color: #92400e; }
    .log-level-error { background: #fee2e2; color: #991b1b; }
    .log-level-debug { background: #e9e9e9; color: #1e293b; }

    .filter-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .log-table {
        font-size: 0.9rem;
    }

    .log-table td {
        vertical-align: middle;
    }

    .badge-ip {
        background: #f1f5f9;
        color: #475569;
        font-family: monospace;
    }
</style>
{% endblock %}

{% block content %}
<!-- Filter Section -->
<div class="filter-section">
    <div class="row">
        <div class="col-md-3">
            <label class="form-label fw-bold">Log Type</label>
            <select class="form-select" id="logType">
                <option value="all">All Activities</option>
                <option value="user">User Activities</option>
                <option value="system">System Events</option>
                <option value="error">Errors</option>
                <option value="security">Security Events</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">Date Range</label>
            <select class="form-select" id="dateRange">
                <option value="today">Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="week" selected>Last 7 Days</option>
                <option value="month">Last 30 Days</option>
                <option value="custom">Custom Range</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">User</label>
            <select class="form-select" id="userFilter">
                <option value="all">All Users</option>
                {% for user in users %}
                <option value="{{ user.id }}">{{ user.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">Severity</label>
            <select class="form-select" id="severityFilter">
                <option value="all">All</option>
                <option value="info">Info</option>
                <option value="warning">Warning</option>
                <option value="error">Error</option>
                <option value="critical">Critical</option>
            </select>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-12">
            <button class="btn btn-primary" onclick="applyFilters()">
                <i class="fas fa-filter me-1"></i>Apply Filters
            </button>
            <button class="btn btn-outline-secondary" onclick="exportLogs()">
                <i class="fas fa-download me-1"></i>Export Logs
            </button>
            <button class="btn btn-outline-danger" onclick="clearLogs()">
                <i class="fas fa-trash me-1"></i>Clear Old Logs
            </button>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value">{{ total_logs }}</div>
            <div class="stat-label">Total Logs</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value text-warning">{{ warning_count }}</div>
            <div class="stat-label">Warnings</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value text-danger">{{ error_count }}</div>
            <div class="stat-label">Errors</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-value text-info">{{ unique_users_logged }}</div>
            <div class="stat-label">Active Users</div>
        </div>
    </div>
</div>

<!-- Tab Navigation -->
<ul class="nav nav-tabs mb-4" id="logTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" type="button">
            <i class="fas fa-stream me-2"></i>Timeline View
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="table-tab" data-bs-toggle="tab" data-bs-target="#table" type="button">
            <i class="fas fa-table me-2"></i>Table View
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button">
            <i class="fas fa-chart-bar me-2"></i>Analytics
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="logTabsContent">
    <!-- Timeline View -->
    <div class="tab-pane fade show active" id="timeline" role="tabpanel">
        <div class="timeline">
            {% for log in logs %}
            <div class="timeline-item">
                <div class="timeline-icon bg-{{ log.color }}" style="background: {{ log.bg_color }}">
                    <i class="fas fa-{{ log.icon }} text-white"></i>
                </div>
                <div class="timeline-content">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="log-level log-level-{{ log.level }}">{{ log.level|upper }}</span>
                            <span class="badge bg-primary ms-2">{{ log.category }}</span>
                        </div>
                        <small class="text-muted">
                            <i class="far fa-clock me-1"></i>{{ log.timestamp }}
                        </small>
                    </div>

                    <h6>{{ log.message }}</h6>

                    <div class="row mt-2">
                        <div class="col-md-6">
                            <small class="text-muted d-block">
                                <i class="fas fa-user me-1"></i>{{ log.user }}
                            </small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted d-block">
                                <i class="fas fa-globe me-1"></i>{{ log.ip_address }}
                            </small>
                        </div>
                    </div>

                    {% if log.details %}
                    <div class="mt-2 p-2 bg-light rounded">
                        <pre class="small mb-0">{{ log.details }}</pre>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Table View -->
    <div class="tab-pane fade" id="table" role="tabpanel">
        <div class="table-container">
            <table class="table log-table" id="logsTable">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Level</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Category</th>
                        <th>IP Address</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>{{ log.timestamp }}</td>
                        <td>
                            <span class="badge bg-{{ 'success' if log.level == 'info'
                                                   else 'warning' if log.level == 'warning'
                                                   else 'danger' }}">
                                {{ log.level }}
                            </span>
                        </td>
                        <td>{{ log.user }}</td>
                        <td>{{ log.message }}</td>
                        <td>{{ log.category }}</td>
                        <td><span class="badge badge-ip">{{ log.ip_address }}</span></td>
                        <td>
                            {% if log.details %}
                            <button class="btn btn-sm btn-link" onclick="showDetails('{{ log.details }}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Analytics View -->
    <div class="tab-pane fade" id="analytics" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="table-container">
                    <h5 class="mb-3"><i class="fas fa-chart-pie me-2 text-primary"></i>Log Distribution</h5>
                    <canvas id="logPieChart" style="height: 300px;"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="table-container">
                    <h5 class="mb-3"><i class="fas fa-chart-line me-2 text-success"></i>Activity Trend</h5>
                    <canvas id="activityTrendChart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="table-container">
                    <h5 class="mb-3"><i class="fas fa-users me-2 text-info"></i>Top Active Users</h5>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Actions</th>
                                <th>Last Activity</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in top_users %}
                            <tr>
                                <td>{{ user.name }}</td>
                                <td><span class="badge bg-primary">{{ user.action_count }}</span></td>
                                <td>{{ user.last_activity }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        $('#logsTable').DataTable({
            pageLength: 25,
            order: [[0, 'desc']],
            language: {
                search: "Search logs:"
            }
        });
    });

    // Log Distribution Chart
    new Chart(document.getElementById('logPieChart'), {
        type: 'doughnut',
        data: {
            labels: {{ log_distribution.labels|safe }},
            datasets: [{
                data: {{ log_distribution.data|safe }},
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#3b82f6']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Activity Trend Chart
    new Chart(document.getElementById('activityTrendChart'), {
        type: 'line',
        data: {
            labels: {{ trend_labels|safe }},
            datasets: [{
                label: 'Activities',
                data: {{ trend_data|safe }},
                borderColor: '#4f46e5',
                tension: 0.4,
                fill: true,
                backgroundColor: 'rgba(79, 70, 229, 0.1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    function applyFilters() {
        const logType = document.getElementById('logType').value;
        const dateRange = document.getElementById('dateRange').value;
        const user = document.getElementById('userFilter').value;
        const severity = document.getElementById('severityFilter').value;

        alert('Applying filters...');
    }

    function exportLogs() {
        alert('Exporting logs...');
    }

    function clearLogs() {
        if(confirm('Clear old logs? This action cannot be undone.')) {
            alert('Clearing logs...');
        }
    }

    function showDetails(details) {
        alert(details);
    }
</script>
{% endblock %}
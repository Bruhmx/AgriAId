{% extends "admin/base_admin.html" %}

{% block title %}Diagnoses History - Admin Panel{% endblock %}

{% block page_title %}Diagnoses History{% endblock %}
{% block page_icon %}history{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Diagnoses History</li>
{% endblock %}

{% block extra_css %}
<style>
    .diagnosis-card {
        transition: all 0.3s;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .diagnosis-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    .confidence-badge {
        font-size: 0.9rem;
        padding: 5px 10px;
    }

    .filter-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .stat-card-small {
        background: white;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .stat-value-small {
        font-size: 1.5rem;
        font-weight: 700;
        color: #4f46e5;
    }

    .table-diagnosis {
        margin-bottom: 0;
    }

    .table-diagnosis th {
        border-top: none;
        background: #f8fafc;
        color: #475569;
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .diagnosis-image {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        object-fit: cover;
    }

    .export-btn {
        border: 2px dashed #cbd5e1;
        background: white;
        color: #64748b;
        padding: 10px 20px;
        border-radius: 10px;
        transition: all 0.3s;
    }

    .export-btn:hover {
        border-color: #4f46e5;
        color: #4f46e5;
        background: #f5f3ff;
    }
</style>
{% endblock %}

{% block header_actions %}
<div class="dropdown">
    <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="fas fa-download me-1"></i>Export
    </button>
    <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#" onclick="exportData('csv')"><i class="fas fa-file-csv me-2"></i>CSV</a></li>
        <li><a class="dropdown-item" href="#" onclick="exportData('excel')"><i class="fas fa-file-excel me-2"></i>Excel</a></li>
        <li><a class="dropdown-item" href="#" onclick="exportData('pdf')"><i class="fas fa-file-pdf me-2"></i>PDF</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="#" onclick="printReport()"><i class="fas fa-print me-2"></i>Print</a></li>
    </ul>
</div>
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card-small">
            <div class="stat-value-small">{{ total_diagnoses }}</div>
            <div class="text-muted">Total Diagnoses</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card-small">
            <div class="stat-value-small">{{ today_diagnoses }}</div>
            <div class="text-muted">Today</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card-small">
            <div class="stat-value-small">{{ avg_confidence }}%</div>
            <div class="text-muted">Avg Confidence</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card-small">
            <div class="stat-value-small">{{ unique_users }}</div>
            <div class="text-muted">Unique Users</div>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="filter-section mb-4">
    <div class="row">
        <div class="col-md-3">
            <label class="form-label fw-bold">Date Range</label>
            <select class="form-select" id="dateRange">
                <option value="today">Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="week" selected>This Week</option>
                <option value="month">This Month</option>
                <option value="custom">Custom Range</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">Crop Type</label>
            <select class="form-select" id="cropFilter">
                <option value="all">All Crops</option>
                {% for crop in crops %}
                <option value="{{ crop.id }}">{{ crop.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">Disease</label>
            <select class="form-select" id="diseaseFilter">
                <option value="all">All Diseases</option>
                {% for disease in diseases %}
                <option value="{{ disease.id }}">{{ disease.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">Confidence Level</label>
            <select class="form-select" id="confidenceFilter">
                <option value="all">All</option>
                <option value="high">High (â‰¥80%)</option>
                <option value="medium">Medium (50-79%)</option>
                <option value="low">Low (<50%)</option>
            </select>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-12">
            <button class="btn btn-primary" onclick="applyFilters()">
                <i class="fas fa-filter me-1"></i>Apply Filters
            </button>
            <button class="btn btn-outline-secondary" onclick="resetFilters()">
                <i class="fas fa-undo me-1"></i>Reset
            </button>
        </div>
    </div>
</div>

<!-- Diagnoses Table -->
<div class="table-container">
    <div class="table-header">
        <h5><i class="fas fa-list me-2 text-primary"></i>Diagnosis Records</h5>
        <div class="d-flex gap-2">
            <input type="text" class="form-control form-control-sm" placeholder="Search..." id="tableSearch" style="width: 250px;">
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-diagnosis" id="diagnosesTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Image</th>
                    <th>User</th>
                    <th>Crop</th>
                    <th>Disease Detected</th>
                    <th>Confidence</th>
                    <th>Date & Time</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for diagnosis in diagnoses %}
                <tr>
                    <td>#{{ diagnosis.id }}</td>
                    <td>
                        <img src="{{ diagnosis.image_url }}" class="diagnosis-image" alt="Diagnosis">
                    </td>
                    <td>
                        <div>
                            <strong>{{ diagnosis.user_name }}</strong>
                            <br>
                            <small class="text-muted">{{ diagnosis.user_role }}</small>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-primary">{{ diagnosis.crop }}</span>
                    </td>
                    <td>
                        <strong>{{ diagnosis.disease_detected }}</strong>
                        <br>
                        <small class="text-muted">Actual: {{ diagnosis.actual_disease|default('Not verified') }}</small>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="progress w-100 me-2" style="height: 8px;">
                                <div class="progress-bar bg-{{ 'success' if diagnosis.confidence >= 80 else 'warning' if diagnosis.confidence >= 50 else 'danger' }}"
                                     style="width: {{ diagnosis.confidence }}%"></div>
                            </div>
                            <span class="badge bg-{{ 'success' if diagnosis.confidence >= 80 else 'warning' if diagnosis.confidence >= 50 else 'danger' }} confidence-badge">
                                {{ diagnosis.confidence }}%
                            </span>
                        </div>
                    </td>
                    <td>
                        <i class="far fa-calendar me-1"></i>{{ diagnosis.date }}
                        <br>
                        <small class="text-muted"><i class="far fa-clock me-1"></i>{{ diagnosis.time }}</small>
                    </td>
                    <td>
                        {% if diagnosis.verified %}
                        <span class="badge bg-success">Verified</span>
                        {% else %}
                        <span class="badge bg-warning">Pending</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewDiagnosis({{ diagnosis.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="verifyDiagnosis({{ diagnosis.id }})">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDiagnosis({{ diagnosis.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav class="mt-3">
        <ul class="pagination justify-content-end">
            <li class="page-item disabled">
                <a class="page-link" href="#">Previous</a>
            </li>
            <li class="page-item active"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item">
                <a class="page-link" href="#">Next</a>
            </li>
        </ul>
    </nav>
</div>

<!-- Charts Section -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="table-container">
            <h5 class="mb-3"><i class="fas fa-chart-pie me-2 text-primary"></i>Diagnoses by Crop</h5>
            <canvas id="cropChart" style="height: 300px;"></canvas>
        </div>
    </div>
    <div class="col-md-6">
        <div class="table-container">
            <h5 class="mb-3"><i class="fas fa-chart-line me-2 text-success"></i>Diagnoses Trend (Last 7 Days)</h5>
            <canvas id="trendChart" style="height: 300px;"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize DataTable
    $(document).ready(function() {
        var table = $('#diagnosesTable').DataTable({
            pageLength: 10,
            ordering: true,
            searching: true,
            info: true,
            language: {
                search: "",
                searchPlaceholder: "Search records..."
            }
        });

        // Custom search
        $('#tableSearch').on('keyup', function() {
            table.search(this.value).draw();
        });
    });

    // Crop Chart
    var ctx1 = document.getElementById('cropChart').getContext('2d');
    new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: {{ crop_labels|safe }},
            datasets: [{
                data: {{ crop_data|safe }},
                backgroundColor: ['#4f46e5', '#06b6d4', '#10b981', '#f59e0b', '#ef4444']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Trend Chart
    var ctx2 = document.getElementById('trendChart').getContext('2d');
    new Chart(ctx2, {
        type: 'line',
        data: {
            labels: {{ trend_labels|safe }},
            datasets: [{
                label: 'Diagnoses',
                data: {{ trend_data|safe }},
                borderColor: '#4f46e5',
                tension: 0.4,
                fill: true,
                backgroundColor: 'rgba(79, 70, 229, 0.1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    function applyFilters() {
        // Implement filter logic
        alert('Applying filters...');
    }

    function resetFilters() {
        document.getElementById('dateRange').value = 'week';
        document.getElementById('cropFilter').value = 'all';
        document.getElementById('diseaseFilter').value = 'all';
        document.getElementById('confidenceFilter').value = 'all';
        applyFilters();
    }

    function exportData(format) {
        alert('Exporting as ' + format.toUpperCase());
    }

    function printReport() {
        window.print();
    }

    function viewDiagnosis(id) {
        window.location.href = "{{ url_for('admin_diagnosis_detail') }}?id=" + id;
    }

    function verifyDiagnosis(id) {
        if(confirm('Mark this diagnosis as verified?')) {
            alert('Verifying diagnosis #' + id);
        }
    }

    function deleteDiagnosis(id) {
        if(confirm('Are you sure you want to delete this diagnosis?')) {
            alert('Deleting diagnosis #' + id);
        }
    }
</script>
{% endblock %}
{% extends "admin/base_admin.html" %}

{% block title %}System Health - Admin Panel{% endblock %}

{% block page_title %}System Health Monitoring{% endblock %}
{% block page_icon %}heartbeat{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item active">System Health</li>
{% endblock %}

{% block extra_css %}
<style>
    .health-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .metric-gauge {
        width: 150px;
        height: 150px;
        margin: 0 auto;
        position: relative;
    }

    .metric-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        font-weight: 700;
    }

    .metric-label {
        text-align: center;
        margin-top: 10px;
        color: #64748b;
    }

    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
    }

    .service-row {
        padding: 10px;
        border-bottom: 1px solid #e9ecef;
    }

    .service-row:last-child {
        border-bottom: none;
    }

    .alert-card {
        border-left: 4px solid;
        margin-bottom: 10px;
        padding: 15px;
        background: white;
        border-radius: 10px;
    }

    .alert-critical { border-left-color: #ef4444; }
    .alert-warning { border-left-color: #f59e0b; }
    .alert-info { border-left-color: #3b82f6; }

    .progress-thin {
        height: 5px;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<!-- System Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="health-card text-center">
            <div class="metric-gauge">
                <canvas id="cpuGauge"></canvas>
                <div class="metric-value">{{ system_health.cpu_usage }}%</div>
            </div>
            <div class="metric-label">CPU Usage</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="health-card text-center">
            <div class="metric-gauge">
                <canvas id="memoryGauge"></canvas>
                <div class="metric-value">{{ system_health.memory_usage }}%</div>
            </div>
            <div class="metric-label">Memory Usage</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="health-card text-center">
            <div class="metric-gauge">
                <canvas id="diskGauge"></canvas>
                <div class="metric-value">{{ system_health.disk_usage }}%</div>
            </div>
            <div class="metric-label">Disk Usage</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="health-card text-center">
            <div class="display-4 text-{{ 'success' if system_health.uptime_days > 30 else 'warning' }}">
                <i class="fas fa-clock"></i>
            </div>
            <div class="metric-value" style="font-size: 1.8rem;">{{ system_health.uptime_days }} days</div>
            <div class="metric-label">Uptime</div>
        </div>
    </div>
</div>

<!-- Services Status -->
<div class="row">
    <div class="col-md-8">
        <div class="health-card">
            <h5 class="mb-3"><i class="fas fa-cogs me-2 text-primary"></i>Services Status</h5>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Service</th>
                            <th>Status</th>
                            <th>Response Time</th>
                            <th>Uptime</th>
                            <th>Last Check</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for service in services %}
                        <tr>
                            <td>
                                <span class="status-indicator status-{{ 'healthy' if service.status == 'operational' else 'warning' if service.status == 'degraded' else 'critical' }}"></span>
                                {{ service.name }}
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if service.status == 'operational' else 'warning' if service.status == 'degraded' else 'danger' }}">
                                    {{ service.status }}
                                </span>
                            </td>
                            <td>{{ service.response_time }}ms</td>
                            <td>{{ service.uptime }}</td>
                            <td>{{ service.last_check }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="health-card mt-4">
            <h5 class="mb-3"><i class="fas fa-chart-line me-2 text-success"></i>Performance Metrics</h5>
            <canvas id="performanceChart" style="height: 300px;"></canvas>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Active Alerts -->
        <div class="health-card">
            <h5 class="mb-3"><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Active Alerts</h5>
            {% for alert in alerts %}
            <div class="alert-card alert-{{ alert.type }}">
                <div class="d-flex justify-content-between">
                    <strong>{{ alert.title }}</strong>
                    <small class="text-muted">{{ alert.time }}</small>
                </div>
                <p class="small mb-1">{{ alert.message }}</p>
                <span class="badge bg-{{ 'danger' if alert.severity == 'critical' else 'warning' }}">
                    {{ alert.severity }}
                </span>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                <p>No active alerts</p>
            </div>
            {% endfor %}
        </div>

        <!-- Database Stats -->
        <div class="health-card mt-4">
            <h5 class="mb-3"><i class="fas fa-database me-2 text-info"></i>Database Status</h5>
            <div class="mb-3">
                <div class="d-flex justify-content-between">
                    <span>Connections</span>
                    <span>{{ db_stats.connections }}/{{ db_stats.max_connections }}</span>
                </div>
                <div class="progress progress-thin">
                    <div class="progress-bar bg-{{ 'success' if db_stats.connection_ratio < 70 else 'warning' }}"
                         style="width: {{ db_stats.connection_ratio }}%"></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between">
                    <span>Query Time</span>
                    <span>{{ db_stats.avg_query_time }}ms</span>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between">
                    <span>Size</span>
                    <span>{{ db_stats.size }}</span>
                </div>
            </div>
            <div>
                <div class="d-flex justify-content-between">
                    <span>Backup Age</span>
                    <span class="text-{{ 'success' if db_stats.backup_age_days < 1 else 'warning' }}">
                        {{ db_stats.backup_age }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="health-card mt-4">
            <h5 class="mb-3"><i class="fas fa-bolt me-2 text-warning"></i>Quick Actions</h5>
            <div class="d-grid gap-2">
                <button class="btn btn-outline-primary" onclick="clearCache()">
                    <i class="fas fa-broom me-2"></i>Clear Cache
                </button>
                <button class="btn btn-outline-success" onclick="backupDatabase()">
                    <i class="fas fa-database me-2"></i>Backup Database
                </button>
                <button class="btn btn-outline-warning" onclick="restartService('all')">
                    <i class="fas fa-sync-alt me-2"></i>Restart Services
                </button>
                <button class="btn btn-outline-info" onclick="viewLogs()">
                    <i class="fas fa-file-alt me-2"></i>View System Logs
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // CPU Gauge
    new Chart(document.getElementById('cpuGauge'), {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [{{ system_health.cpu_usage }}, 100 - {{ system_health.cpu_usage }}],
                backgroundColor: ['#4f46e5', '#e9ecef'],
                borderWidth: 0
            }]
        },
        options: {
            cutout: '80%',
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            }
        }
    });

    // Memory Gauge
    new Chart(document.getElementById('memoryGauge'), {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [{{ system_health.memory_usage }}, 100 - {{ system_health.memory_usage }}],
                backgroundColor: ['#10b981', '#e9ecef'],
                borderWidth: 0
            }]
        },
        options: {
            cutout: '80%',
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            }
        }
    });

    // Disk Gauge
    new Chart(document.getElementById('diskGauge'), {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [{{ system_health.disk_usage }}, 100 - {{ system_health.disk_usage }}],
                backgroundColor: ['#f59e0b', '#e9ecef'],
                borderWidth: 0
            }]
        },
        options: {
            cutout: '80%',
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            }
        }
    });

    // Performance Chart
    new Chart(document.getElementById('performanceChart'), {
        type: 'line',
        data: {
            labels: {{ performance_labels|safe }},
            datasets: [{
                label: 'Response Time (ms)',
                data: {{ performance_data|safe }},
                borderColor: '#4f46e5',
                tension: 0.4,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    function clearCache() {
        if(confirm('Clear system cache?')) {
            alert('Clearing cache...');
        }
    }

    function backupDatabase() {
        if(confirm('Create database backup?')) {
            alert('Creating backup...');
        }
    }

    function restartService(service) {
        if(confirm('Restart ' + service + ' services?')) {
            alert('Restarting services...');
        }
    }

    function viewLogs() {
        window.location.href = "{{ url_for('admin_system_logs') }}";
    }
</script>
{% endblock %}
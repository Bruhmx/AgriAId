{% extends "base.html" %}

{% block title %}Disease Library - AgriAId{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fas fa-book-medical me-2"></i>Disease Library</h2>
            <p class="text-muted">Comprehensive information about crop diseases and their management</p>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6 class="mb-2">Select Crop</h6>
                    <div class="btn-group w-100" role="group">
                        <a href="/disease-library?crop=corn"
                           class="btn btn-outline-success {{ 'active' if crop == 'corn' else '' }}">
                            <i class="fas fa-corn me-2"></i>Corn
                        </a>
                        <a href="/disease-library?crop=rice"
                           class="btn btn-outline-success {{ 'active' if crop == 'rice' else '' }}">
                            <i class="fas fa-rice me-2"></i>Rice
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-info">
        <h5><i class="fas fa-lightbulb me-2"></i>How to Use This Library</h5>
        <ul class="mb-0">
            <li>Browse diseases by clicking on the cards below</li>
            <li>Compare symptoms with your field observations</li>
            <li>Learn about treatment options for each disease</li>
            <li>Use the information to make informed decisions</li>
        </ul>
    </div>

    {% if diseases %}
    <div class="row">
        {% for disease in diseases %}
        <div class="col-md-6 mb-4">
            <div class="card disease-card h-100"
                 onclick="showDiseaseInfo('{{ crop }}', '{{ disease.disease_code }}')"
                 style="cursor: pointer;">
                <div class="row g-0">
                    <div class="col-md-4">
                        <!-- UPDATED: Use formatted disease_code as name and proper image URL -->
                        <img src="{% if disease.sample_image %}{{ disease.sample_image }}{% else %}{{ url_for('static', filename='img/disease-placeholder.jpg') }}{% endif %}"
                             class="img-fluid rounded-start h-100"
                             alt="{{ disease.disease_code|replace('_', ' ')|title }}"
                             style="object-fit: cover; height: 180px; width: 100%;"
                             onerror="this.src='{{ url_for('static', filename='img/disease-placeholder.jpg') }}'">
                    </div>
                    <div class="col-md-8">
                        <div class="card-body">
                            <!-- UPDATED: Use formatted disease_code since disease_name doesn't exist -->
                            <h5 class="card-title">{{ disease.disease_code|replace('_', ' ')|title }}</h5>
                            <p class="card-text text-muted small mb-2">
                                <strong>Symptoms:</strong> {{ disease.symptoms[:150] if disease.symptoms else 'No description available' }}...
                            </p>
                            <div class="mt-2">
                                <span class="badge bg-info">{{ crop_display }}</span>
                                {% if disease.sample_count %}
                                <span class="badge bg-secondary ms-1">{{ disease.sample_count }} sample images</span>
                                {% endif %}
                                <span class="badge bg-primary ms-1">Click for details</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-seedling fa-4x text-muted mb-3"></i>
        <h4>No disease information available</h4>
        <p class="text-muted">Disease information will appear here once added to the database.</p>
    </div>
    {% endif %}

    <div class="card mt-4">
        <div class="card-header bg-warning">
            <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Important Notes</h5>
        </div>
        <div class="card-body">
            <ul class="mb-0">
                <li>Always confirm diagnosis with local agricultural experts</li>
                <li>Follow recommended safety precautions when applying treatments</li>
                <li>Consider environmental conditions and crop growth stage</li>
                <li>Integrated Pest Management (IPM) is recommended for sustainable control</li>
                <li>Regular monitoring and early detection are key to effective management</li>
            </ul>
        </div>
    </div>
</div>

<!-- Disease Info Modal -->
<div class="modal fade" id="diseaseInfoModal" tabindex="-1" aria-labelledby="diseaseInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="diseaseInfoModalLabel">Disease Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="diseaseInfoContent">
                <!-- Content loaded via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Close
                </button>
                <button type="button" class="btn btn-primary" onclick="printDiseaseInfo()">
                    <i class="fas fa-print me-2"></i>Print
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Function to show disease information
function showDiseaseInfo(crop, diseaseCode) {
    // Show loading state
    document.getElementById('diseaseInfoContent').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading disease information...</p>
        </div>
    `;

    // Fetch disease information
    fetch(`/api/disease-info?crop=${crop}&disease=${diseaseCode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayDiseaseInfo(data);
            } else {
                document.getElementById('diseaseInfoContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Could not load disease information. Please try again.
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('diseaseInfoContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading disease information.
                </div>
            `;
        });

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('diseaseInfoModal'));
    modal.show();
}

// Display disease information in modal - UPDATED for BLOB storage
function displayDiseaseInfo(data) {
    // Create a display name from disease code if disease_name not provided
    const displayName = data.disease_name ||
                       data.disease_code.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

    // Determine if there are sample images
    const hasSamples = data.sample_images && data.sample_images.length > 0;

    const content = `
        <div class="disease-info">
            <div class="row mb-4">
                <div class="col-md-4 text-center">
                    <img src="${data.image_url || '{{ url_for('static', filename='img/disease-placeholder.jpg') }}'}"
                         class="img-fluid rounded mb-3"
                         alt="${displayName}"
                         style="max-height: 200px; width: 100%; object-fit: contain;"
                         onerror="this.src='{{ url_for('static', filename='img/disease-placeholder.jpg') }}'">
                    <h4 class="text-primary">${displayName}</h4>
                    <span class="badge bg-info">${data.crop_display}</span>
                </div>
                <div class="col-md-8">
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-bug me-2 text-danger"></i>Causal Agent</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">${data.cause || 'Information not available'}</p>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-eye me-2 text-warning"></i>Symptoms</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">${data.symptoms || 'Information not available'}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sample Images Gallery - UPDATED for BLOB storage -->
            ${hasSamples ? `
                <div class="row">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-images me-2"></i>Symptom Progression (${data.sample_images.length} images)
                        </h6>
                        <div class="row">
                            ${data.sample_images.map((img, index) => `
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="card h-100 sample-image-card"
                                         onclick="viewFullImage('${img.url}')"
                                         style="cursor: pointer;">
                                        <img src="${img.url || '{{ url_for('static', filename='img/disease-placeholder.jpg') }}'}"
                                             class="card-img-top"
                                             alt="Sample ${index + 1}"
                                             style="height: 100px; object-fit: cover;"
                                             onerror="this.src='{{ url_for('static', filename='img/disease-placeholder.jpg') }}'">
                                        <div class="card-body p-2 text-center">
                                            <p class="small mb-1">${img.title || `Sample ${index + 1}`}</p>
                                            ${img.severity ? `
                                                <span class="badge bg-${getSeverityColor(img.severity)}">
                                                    ${img.severity} Stage
                                                </span>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            ` : ''}

            <!-- Treatment Information -->
            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-leaf me-2"></i>Organic Treatment</h6>
                        </div>
                        <div class="card-body">
                            <p class="small">${data.organic_treatment || 'Use resistant varieties, practice crop rotation'}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header bg-warning">
                            <h6 class="mb-0"><i class="fas fa-flask me-2"></i>Chemical Treatment</h6>
                        </div>
                        <div class="card-body">
                            <p class="small">${data.chemical_treatment || 'Apply appropriate fungicides as needed'}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Prevention</h6>
                        </div>
                        <div class="card-body">
                            <p class="small">${data.prevention || 'Maintain field hygiene, use disease-free seeds'}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manual Treatment if available -->
            ${data.manual_treatment ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0"><i class="fas fa-hand-paper me-2"></i>Manual Treatment</h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-0">${data.manual_treatment}</p>
                            </div>
                        </div>
                    </div>
                </div>
            ` : ''}

            ${data.last_updated ? `
                <div class="text-muted text-end mt-3">
                    <small>Last updated: ${new Date(data.last_updated).toLocaleDateString()}</small>
                </div>
            ` : ''}
        </div>
    `;

    document.getElementById('diseaseInfoContent').innerHTML = content;
    document.getElementById('diseaseInfoModalLabel').textContent = `${displayName} Information`;
}

// Helper function for severity colors
function getSeverityColor(severity) {
    const colors = {
        'Early': 'success',
        'Moderate': 'warning',
        'Advanced': 'danger',
        'Severe': 'dark'
    };
    return colors[severity] || 'secondary';
}

// View full image in new tab
function viewFullImage(imageUrl) {
    if (imageUrl && imageUrl !== '{{ url_for('static', filename='img/disease-placeholder.jpg') }}') {
        window.open(imageUrl, '_blank');
    } else {
        alert('Full image not available');
    }
}

// Print disease information
function printDiseaseInfo() {
    const printContent = document.getElementById('diseaseInfoContent').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Disease Information</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { padding: 20px; }
                img { max-width: 300px; }
                .card { margin-bottom: 15px; }
                .badge { display: inline-block; padding: 0.25em 0.5em; }
                @media print {
                    .btn { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="container">
                ${printContent}
                <div class="text-center mt-4 no-print">
                    <button class="btn btn-primary" onclick="window.print()">Print</button>
                </div>
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
}
</script>

<style>
.disease-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    border-radius: 10px;
    overflow: hidden;
}

.disease-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

.sample-image-card {
    transition: opacity 0.2s ease;
}

.sample-image-card:hover {
    opacity: 0.8;
}

.modal-lg {
    max-width: 900px;
}

.card-header {
    font-weight: 600;
}

.badge {
    font-weight: 500;
    padding: 0.5em 0.8em;
}

.text-truncate-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}
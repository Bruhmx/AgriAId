{% extends "base.html" %}

{% block title %}Final Diagnosis - AgriAId{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-diagnoses me-2"></i>Final Diagnosis</h5>
            </div>
            <div class="card-body text-center">
                <div class="mb-4">
                    <h3 class="text-primary">{{ result.disease }}</h3>
                    <span class="badge bg-{{ 'success' if result.severity == 'Mild' else 'warning' if result.severity == 'Moderate' else 'danger' }} fs-6 mt-2">
                        {{ result.severity }} Severity
                    </span>
                </div>

                <div class="mb-3">
                    <h6>Confidence Level</h6>
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar bg-{{ 'success' if result.confidence > 70 else 'warning' if result.confidence > 50 else 'danger' }}"
                             role="progressbar"
                             style="width: {{ result.confidence }}%">
                            {{ result.confidence }}%
                        </div>
                    </div>
                    <small class="text-muted">After expert validation</small>
                </div>

                <div class="mb-3">
                    <h6>Crop Identified</h6>
                    <span class="badge bg-info fs-6">{{ result.crop }}</span>
                </div>

                <div class="text-center mt-4">
                    <img src="{{ url_for('static', filename='uploads/' + result.image_path) }}"
                         class="img-fluid rounded"
                         alt="Analyzed image"
                         style="max-height: 200px;">
                    <p class="small text-muted mt-2">Your uploaded image</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>System Accuracy</h6>
            </div>
            <div class="card-body">
                <p class="small">
                    This diagnosis combines:
                </p>
                <ul class="small">
                    <li>AI image analysis</li>
                    <li>Expert-based validation</li>
                    <li>Agricultural knowledge base</li>
                </ul>
                <div class="alert alert-warning small mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Always consult with local agricultural experts for confirmation.
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <!-- Disease Information Section -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Disease Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6><i class="fas fa-bug text-danger me-2"></i>Cause</h6>
                        <p class="text-muted">{{ result.cause }}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6><i class="fas fa-eye text-warning me-2"></i>Symptoms</h6>
                        <p class="text-muted">{{ result.symptoms }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Treatment Recommendations Section -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-prescription me-2"></i>Treatment Recommendations</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Manual Treatment -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-primary bg-opacity-25">
                                <h6 class="mb-0"><i class="fas fa-hands-helping me-2"></i>Manual Treatment</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">{{ result.manual_treatment }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Organic Treatment -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-success bg-opacity-25">
                                <h6 class="mb-0"><i class="fas fa-leaf me-2"></i>Organic Treatment</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">{{ result.organic_treatment }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chemical Treatment -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-warning bg-opacity-25">
                                <h6 class="mb-0"><i class="fas fa-flask me-2"></i>Chemical Treatment</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">{{ result.chemical_treatment }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Treatment Priority Guide -->
                <div class="alert alert-info mt-3">
                    <h6><i class="fas fa-lightbulb me-2"></i>Treatment Priority Guide</h6>
                    <p class="mb-0 small">
                        <strong>For {{ result.severity }} cases:</strong>
                        {% if result.severity == 'Mild' %}
                        Start with manual treatments, then organic methods if needed.
                        {% elif result.severity == 'Moderate' %}
                        Combine manual and organic treatments. Consider chemicals if symptoms persist.
                        {% else %}
                        Use integrated approach: manual + organic + chemical treatments as needed.
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- Preventive Measures -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Preventive Measures</h5>
            </div>
            <div class="card-body">
                <p>{{ result.prevention }}</p>
            </div>
        </div>

<!-- Sample Images Section -->
<!-- In your results.html, find the sample images section and fix it: -->
{% if result.sample_images %}
<div class="row mt-4">
    {% for sample in result.sample_images %}
    <div class="col-md-3 col-6 mb-3">
        <div class="card h-100">
            <img src="{{ sample.url }}" class="card-img-top" alt="{{ sample.title }}"
                 style="height: 150px; object-fit: cover;">
            <div class="card-body">
                <h6 class="card-title">{{ sample.title }}</h6>
                <p class="card-text small">{{ sample.description }}</p>
                <!--<span class="badge bg-{% if sample.severity == 'Early' %}info{% elif sample.severity == 'Moderate' %}warning{% elif sample.severity == 'Advanced' %}danger{% else %}dark{% endif %}">
                    {{ sample.severity }}
                </span> -->
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Image Modal for enlarged view -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Sample Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid rounded" alt="Enlarged sample image" style="max-height: 70vh;">
                <p id="modalDescription" class="mt-3"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Close
                </button>
                <button type="button" class="btn btn-primary" onclick="downloadImage()">
                    <i class="fas fa-download me-2"></i>Download
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for image modal -->
<script>
// Handle click on sample images
document.addEventListener('DOMContentLoaded', function() {
    const imageCards = document.querySelectorAll('.clickable-image');

    imageCards.forEach(card => {
        card.addEventListener('click', function() {
            const imgSrc = this.getAttribute('data-img-src');
            const imgTitle = this.getAttribute('data-img-title');

            document.getElementById('modalImage').src = imgSrc;
            document.getElementById('modalImage').alt = imgTitle;
            document.getElementById('imageModalLabel').textContent = imgTitle;

            // Get stage from the badge text
            const stage = this.querySelector('.badge')?.textContent || '';
            const disease = "{{ result.disease }}";
            const description = `${disease} - ${stage}`;
            document.getElementById('modalDescription').textContent = description;
        });
    });

    // Also make the uploaded image clickable
    const uploadedImg = document.querySelector('img[alt="Analyzed image"]');
    if (uploadedImg) {
        uploadedImg.style.cursor = 'pointer';
        uploadedImg.addEventListener('click', function() {
            document.getElementById('modalImage').src = this.src;
            document.getElementById('modalImage').alt = 'Your uploaded image';
            document.getElementById('imageModalLabel').textContent = 'Your Uploaded Image';
            document.getElementById('modalDescription').textContent = '{{ result.disease }} - {{ result.severity }} severity';
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        });
    }
});

// Download image function
function downloadImage() {
    const imgSrc = document.getElementById('modalImage').src;
    const imgTitle = document.getElementById('imageModalLabel').textContent;

    // Create a temporary link
    const link = document.createElement('a');
    link.href = imgSrc;
    link.download = imgTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.jpg';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Add print functionality for images
function printReport() {
    window.print();
}
</script>

<!-- Additional CSS for better image display -->
<style>
.clickable-image {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.clickable-image:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}

.clickable-image img {
    transition: opacity 0.3s ease;
}

.clickable-image:hover img {
    opacity: 0.9;
}

#modalImage {
    max-width: 100%;
    height: auto;
    border: 1px solid #ddd;
    border-radius: 5px;
}

@media print {
    .clickable-image {
        break-inside: avoid;
        page-break-inside: avoid;
    }

    .modal, .modal-backdrop {
        display: none !important;
    }
}
</style>

        <!-- Action Buttons -->
        <div class="d-grid gap-2">
            <a href="/upload" class="btn btn-success btn-lg">
                <i class="fas fa-redo me-2"></i>Analyze Another Image
            </a>
            <button onclick="window.print()" class="btn btn-outline-primary">
                <i class="fas fa-print me-2"></i>Print Report
            </button>
            <a href="/" class="btn btn-outline-secondary">
                <i class="fas fa-home me-2"></i>Back to Home
            </a>
        </div>
    </div>
</div>

<!-- Print Styles -->
<style>
@media print {
    .navbar, .footer, .btn, .d-grid {
        display: none !important;
    }
    .card {
        break-inside: avoid;
    }
    .sample-images {
        page-break-before: always;
    }
}
</style>
{% endblock %}
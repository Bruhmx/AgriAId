{% extends "base.html" %}

{% block title %}Settings - AgriAId{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Page Header -->
            <div class="page-header mb-5">
                <h1 class="display-5 mb-3">
                    <i class="fas fa-cog me-2 text-primary"></i>Settings
                </h1>
                <p class="lead text-muted">
                    Manage your account preferences, notification settings, and privacy options.
                </p>
            </div>

            <div class="row">
                <!-- Left Navigation -->
                <div class="col-lg-3">
                    <div class="list-group mb-4">
                        <a href="#account" class="list-group-item list-group-item-action active" data-bs-toggle="tab">
                            <i class="fas fa-user-circle me-2"></i>Account
                        </a>
                        <a href="#profile" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                            <i class="fas fa-id-card me-2"></i>Profile
                        </a>
                        <a href="#notifications" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                            <i class="fas fa-bell me-2"></i>Notifications
                        </a>
                        <a href="#privacy" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                            <i class="fas fa-shield-alt me-2"></i>Privacy & Security
                        </a>
                        <a href="#preferences" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                            <i class="fas fa-sliders-h me-2"></i>Preferences
                        </a>
                        <a href="#danger" class="list-group-item list-group-item-action text-danger" data-bs-toggle="tab">
                            <i class="fas fa-exclamation-triangle me-2"></i>Danger Zone
                        </a>
                    </div>

                    <!-- Quick Stats -->
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h6 class="card-title mb-3">Account Overview</h6>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Member Since:</span>
                                <strong>{{ account_stats.created_at.strftime('%B %Y') if account_stats and account_stats.created_at else 'N/A' }}</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Diagnoses:</span>
                                <strong>{{ account_stats.total_diagnosis if account_stats else '0' }}</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Saved Items:</span>
                                <strong>{{ account_stats.saved_items if account_stats else '0' }}</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Last Login:</span>
                                <strong>{{ account_stats.last_login.strftime('%Y-%m-%d %H:%M') if account_stats and account_stats.last_login else 'Never' }}</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Content -->
                <div class="col-lg-9">
                    <div class="tab-content">
                        <!-- Account Tab -->
                        <div class="tab-pane fade show active" id="account">
                            <div class="card shadow-sm">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-user-circle me-2"></i>Account Information</h5>
                                </div>
                                <div class="card-body">
                                    <form method="POST" action="{{ url_for('settings') }}" id="accountForm">
                                        <input type="hidden" name="form_id" value="accountForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="username" class="form-label">Username</label>
                                                <input type="text" class="form-control" id="username"
                                                       value="{{ user.username }}" disabled>
                                                <small class="form-text text-muted">Username cannot be changed</small>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="email" class="form-label">Email Address *</label>
                                                <input type="email" class="form-control" id="email" name="email"
                                                       value="{{ user.email }}" required>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="user_type" class="form-label">Account Type</label>
                                                <input type="text" class="form-control" id="user_type"
                                                       value="{{ user.user_type|title if user.user_type else 'User' }}" disabled>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="account_status" class="form-label">Account Status</label>
                                                <input type="text" class="form-control" id="account_status"
                                                       value="{{ 'Active' if user.is_active else 'Inactive' }}" disabled>
                                            </div>
                                        </div>

                                        <hr class="my-4">

                                        <h6 class="mb-3">Change Password</h6>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="current_password" class="form-label">Current Password</label>
                                                <input type="password" class="form-control" id="current_password" name="current_password">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="new_password" class="form-label">New Password</label>
                                                <input type="password" class="form-control" id="new_password" name="new_password">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="confirm_password" class="form-label">Confirm Password</label>
                                                <input type="password" class="form-control" id="confirm_password" name="confirm_password">
                                            </div>
                                        </div>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Leave password fields empty if you don't want to change your password.
                                        </div>

                                        <div class="d-flex justify-content-end">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save me-1"></i>Save Changes
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Profile Tab (with image upload) -->
                        <div class="tab-pane fade" id="profile">
                            <div class="card shadow-sm">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-id-card me-2"></i>Profile Information</h5>
                                </div>
                                <div class="card-body">
                                    <form method="POST" action="{{ url_for('settings') }}" enctype="multipart/form-data" id="profileForm">
                                        <input type="hidden" name="form_id" value="profileForm">
                                        <div class="row align-items-center mb-4">
                                            <div class="col-auto">
                                                <div class="avatar-upload">
                                                    <div class="avatar-preview mb-2">
                                                        {% if user.profile_image %}
                                                        <img id="profileImagePreview"
                                                             src="{{ url_for('static', filename='uploads/profiles/' + user.profile_image) }}"
                                                             class="rounded-circle"
                                                             width="100"
                                                             height="100"
                                                             style="object-fit: cover; border: 3px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"
                                                             alt="Profile picture">
                                                        {% else %}
                                                        <div id="profileImage-Preview"
                                                             class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
                                                             style="width: 100px; height: 100px; font-size: 2.5rem; border: 3px solid #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                                            {{ user.username[0]|upper if user.username else 'U' }}
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    <input type="file" class="form-control form-control-sm" id="profile_image" name="profile_image"
                                                           accept="image/*" onchange="previewImage(this)">
                                                    <small class="form-text text-muted">Max 2MB, JPG/PNG format</small>
                                                </div>
                                            </div>
                                            <div class="col">
                                                <p class="mb-2">
                                                    <strong>Profile Picture</strong>
                                                </p>
                                                <p class="small text-muted mb-0">
                                                    Upload a clear photo of yourself. This helps personalize your experience.
                                                </p>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="full_name" class="form-label">Full Name</label>
                                                <input type="text" class="form-control" id="full_name" name="full_name"
                                                    value="{{ user.full_name or '' }}">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="phone" class="form-label">Phone Number</label>
                                                <input type="tel" class="form-control" id="phone" name="phone" value="{{ user.phone_number or user.phone or '' }}">
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="location" class="form-label">Location</label>
                                                <input type="text" class="form-control" id="location" name="location"
                                                       value="{{ user.location or '' }}" placeholder="City, Country">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="language" class="form-label">Preferred Language</label>
                                                <select class="form-select" id="language" name="language">
                                                    <option value="en" {% if user.language =='en' %}selected{% endif %}>English</option>
                                                    <option value="es" {% if user.language =='es' %}selected{% endif %}>Spanish</option>
                                                    <option value="fr" {% if user.language =='fr' %}selected{% endif %}>French</option>
                                                    <option value="de" {% if user.language =='de' %}selected{% endif %}>German</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="bio" class="form-label">Bio/Description</label>
                                            <textarea class="form-control" id="bio" name="bio" rows="3"
                                                      placeholder="Tell us about yourself and your farming experience...">{{ user.bio or '' }}</textarea>
                                            <small class="form-text text-muted">Maximum 500 characters</small>
                                        </div>

                                        <div class="d-flex justify-content-end">
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-save me-1"></i>Update Profile
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Notifications Tab (FIXED: removed enctype, correct form_id) -->
                        <div class="tab-pane fade" id="notifications">
                            <div class="card shadow-sm">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0"><i class="fas fa-bell me-2"></i>Notification Settings</h5>
                                </div>
                                <div class="card-body">
                                    <form method="POST" action="{{ url_for('settings') }}" id="notificationsForm">
                                        <input type="hidden" name="form_id" value="notificationsForm">
                                        <div class="mb-4">
                                            <h6 class="mb-3">Email Notifications</h6>
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="email_notifications" name="email_notifications"
                                                       {% if settings and settings.email_notifications %}checked{% endif %}>
                                                <label class="form-check-label" for="email_notifications">
                                                    Diagnosis completion alerts
                                                </label>
                                            </div>
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="email_updates" name="email_updates"
                                                       {% if settings and settings.email_updates %}checked{% endif %}>
                                                <label class="form-check-label" for="email_updates">
                                                    System updates and announcements
                                                </label>
                                            </div>
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="email_newsletter" name="email_newsletter"
                                                       {% if settings and settings.email_newsletter %}checked{% endif %}>
                                                <label class="form-check-label" for="email_newsletter">
                                                    Monthly newsletter and tips
                                                </label>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="email_promotions" name="email_promotions"
                                                       {% if settings and settings.email_promotions %}checked{% endif %}>
                                                <label class="form-check-label" for="email_promotions">
                                                    Promotional offers
                                                </label>
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <h6 class="mb-3">In-App Notifications</h6>
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="app_notifications" name="app_notifications"
                                                       {% if settings and settings.app_notifications %}checked{% endif %}>
                                                <label class="form-check-label" for="app_notifications">
                                                    New diagnosis features
                                                </label>
                                            </div>
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="app_security" name="app_security"
                                                       {% if settings and settings.app_security %}checked{% endif %}>
                                                <label class="form-check-label" for="app_security">
                                                    Security alerts
                                                </label>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="app_reminders" name="app_reminders"
                                                       {% if settings and settings.app_reminders %}checked{% endif %}>
                                                <label class="form-check-label" for="app_reminders">
                                                    Reminders and follow-ups
                                                </label>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <h6 class="mb-3">Notification Frequency</h6>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="radio" name="frequency" id="frequency_realtime"
                                                       value="realtime" {% if settings and settings.frequency =='realtime' %}checked{% endif %}>
                                                <label class="form-check-label" for="frequency_realtime">
                                                    Real-time (immediate notifications)
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="radio" name="frequency" id="frequency_daily"
                                                       value="daily" {% if settings and settings.frequency =='daily' %}checked{% endif %}>
                                                <label class="form-check-label" for="frequency_daily">
                                                    Daily digest
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="frequency" id="frequency_weekly"
                                                       value="weekly" {% if settings and settings.frequency =='weekly' %}checked{% endif %}>
                                                <label class="form-check-label" for="frequency_weekly">
                                                    Weekly summary
                                                </label>
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-end">
                                            <button type="submit" class="btn btn-warning">
                                                <i class="fas fa-save me-1"></i>Save Notification Settings
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Privacy & Security Tab -->
                        <div class="tab-pane fade" id="privacy">
                            <div class="card shadow-sm">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Privacy & Security</h5>
                                </div>
                                <div class="card-body">
                                    <form method="POST" action="{{ url_for('settings') }}" id="privacyForm">
                                        <input type="hidden" name="form_id" value="privacyForm">
                                        <div class="mb-4">
                                            <h6 class="mb-3">Privacy Settings</h6>
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="profile_public" name="profile_public"
                                                       {% if settings and settings.profile_public %}checked{% endif %}>
                                                <label class="form-check-label" for="profile_public">
                                                    Make my profile public
                                                </label>
                                                <small class="form-text text-muted d-block">
                                                    Other users can see your name and activity
                                                </small>
                                            </div>
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="show_diagnosis" name="show_diagnosis"
                                                       {% if settings and settings.show_diagnosis %}checked{% endif %}>
                                                <label class="form-check-label" for="show_diagnosis">
                                                    Show my diagnosis history
                                                </label>
                                            </div>
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="data_collection" name="data_collection"
                                                       {% if settings and settings.data_collection %}checked{% endif %}>
                                                <label class="form-check-label" for="data_collection">
                                                    Allow data collection for research
                                                </label>
                                                <small class="form-text text-muted d-block">
                                                    Anonymous data helps improve the system
                                                </small>
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <h6 class="mb-3">Security</h6>
                                            <div class="d-flex align-items-center mb-3">
                                                <div class="flex-grow-1">
                                                    <strong>Two-Factor Authentication</strong>
                                                    <p class="mb-0 text-muted small">Add an extra layer of security to your account</p>
                                                </div>
                                                {% if settings and settings.two_factor_enabled %}
                                                <span class="badge bg-success">Enabled</span>
                                                <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="disable2FA()">
                                                    Disable
                                                </button>
                                                {% else %}
                                                <span class="badge bg-secondary">Disabled</span>
                                                <button type="button" class="btn btn-sm btn-outline-success ms-2" onclick="enable2FA()">
                                                    Enable
                                                </button>
                                                {% endif %}
                                            </div>

                                            <div class="d-flex align-items-center">
                                                <div class="flex-grow-1">
                                                    <strong>Active Sessions</strong>
                                                    <p class="mb-0 text-muted small">Manage your logged-in devices</p>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewSessions()">
                                                    View Sessions
                                                </button>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <h6 class="mb-3">Data Management</h6>
                                            <div class="d-grid gap-2">
                                                <button type="button" class="btn btn-outline-secondary" onclick="exportData()">
                                                    <i class="fas fa-download me-2"></i>Export My Data
                                                </button>
                                                <button type="button" class="btn btn-outline-warning" onclick="clearHistory()">
                                                    <i class="fas fa-trash me-2"></i>Clear Diagnosis History
                                                </button>
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-end">
                                            <button type="submit" class="btn btn-info">
                                                <i class="fas fa-save me-1"></i>Save Privacy Settings
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Preferences Tab -->
                        <div class="tab-pane fade" id="preferences">
                            <div class="card shadow-sm">
                                <div class="card-header bg-secondary text-white">
                                    <h5 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Application Preferences</h5>
                                </div>
                                <div class="card-body">
                                    <form method="POST" action="{{ url_for('settings') }}" id="preferencesForm">
                                        <input type="hidden" name="form_id" value="preferencesForm">
                                        <div class="mb-4">
                                            <h6 class="mb-3">Display Preferences</h6>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="theme" class="form-label">Theme</label>
                                                    <select class="form-select" id="theme" name="theme">
                                                        <option value="light" {% if settings and settings.theme =='light' %}selected{% endif %}>Light</option>
                                                        <option value="dark" {% if settings and settings.theme =='dark' %}selected{% endif %}>Dark</option>
                                                        <option value="auto" {% if settings and settings.theme =='auto' %}selected{% endif %}>Auto (System)</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="density" class="form-label">Display Density</label>
                                                    <select class="form-select" id="density" name="density">
                                                        <option value="compact" {% if settings and settings.density =='compact' %}selected{% endif %}>Compact</option>
                                                        <option value="comfortable" {% if settings and settings.density =='comfortable' %}selected{% endif %}>Comfortable</option>
                                                        <option value="spacious" {% if settings and settings.density =='spacious' %}selected{% endif %}>Spacious</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <h6 class="mb-3">Diagnosis Preferences</h6>
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="auto_save" name="auto_save"
                                                       {% if settings and settings.auto_save %}checked{% endif %}>
                                                <label class="form-check-label" for="auto_save">
                                                    Auto-save diagnosis results
                                                </label>
                                            </div>
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="show_tips" name="show_tips"
                                                       {% if settings and settings.show_tips %}checked{% endif %}>
                                                <label class="form-check-label" for="show_tips">
                                                    Show helpful tips
                                                </label>
                                            </div>
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" type="checkbox" id="detailed_results" name="detailed_results"
                                                       {% if settings and settings.detailed_results %}checked{% endif %}>
                                                <label class="form-check-label" for="detailed_results">
                                                    Show detailed results by default
                                                </label>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="quick_analysis" name="quick_analysis"
                                                       {% if settings and settings.quick_analysis %}checked{% endif %}>
                                                <label class="form-check-label" for="quick_analysis">
                                                    Enable quick analysis mode
                                                </label>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <h6 class="mb-3">Default Crop Settings</h6>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="default_crop" class="form-label">Default Crop</label>
                                                    <select class="form-select" id="default_crop" name="default_crop">
                                                        <option value="">Ask every time</option>
                                                        <option value="corn" {% if settings and settings.default_crop =='corn' %}selected{% endif %}>Corn</option>
                                                        <option value="rice" {% if settings and settings.default_crop =='rice' %}selected{% endif %}>Rice</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="measurement_unit" class="form-label">Measurement Unit</label>
                                                    <select class="form-select" id="measurement_unit" name="measurement_unit">
                                                        <option value="metric" {% if settings and settings.measurement_unit =='metric' %}selected{% endif %}>Metric (cm, kg)</option>
                                                        <option value="imperial" {% if settings and settings.measurement_unit =='imperial' %}selected{% endif %}>Imperial (inches, lbs)</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-end">
                                            <button type="submit" class="btn btn-secondary">
                                                <i class="fas fa-save me-1"></i>Save Preferences
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Danger Zone Tab -->
                        <div class="tab-pane fade" id="danger">
                            <div class="card border-danger shadow-sm">
                                <div class="card-header bg-danger text-white">
                                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Danger Zone</h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-danger">
                                        <i class="fas fa-exclamation-circle me-2"></i>
                                        <strong>Warning:</strong> These actions are irreversible. Please proceed with caution.
                                    </div>

                                    <div class="mb-4">
                                        <h6 class="mb-3">Account Deletion</h6>
                                        <p class="text-muted mb-3">
                                            Permanently delete your account and all associated data. This action cannot be undone.
                                        </p>
                                        <button type="button" class="btn btn-danger" onclick="deleteAccount()">
                                            <i class="fas fa-trash me-1"></i>Delete My Account
                                        </button>
                                    </div>

                                    <hr class="my-4">

                                    <div class="mb-4">
                                        <h6 class="mb-3">Reset All Settings</h6>
                                        <p class="text-muted mb-3">
                                            Reset all your preferences and settings to their default values.
                                        </p>
                                        <button type="button" class="btn btn-warning" onclick="resetSettings()">
                                            <i class="fas fa-redo me-1"></i>Reset All Settings
                                        </button>
                                    </div>

                                    <hr class="my-4">

                                    <div>
                                        <h6 class="mb-3">Download Account Data</h6>
                                        <p class="text-muted mb-3">
                                            Download all your personal data stored in our system.
                                        </p>
                                        <button type="button" class="btn btn-outline-primary" onclick="downloadAccountData()">
                                            <i class="fas fa-file-download me-1"></i>Download All Data
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sessions Modal -->
<div class="modal fade" id="sessionsModal" tabindex="-1" aria-labelledby="sessionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sessionsModalLabel">Active Sessions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="sessionsList">
                <!-- Sessions will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="terminateAllSessions()">
                    Terminate All Other Sessions
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
                <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header bg-{{ category }} text-white">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong class="me-auto">Notification</strong>
                        <small>just now</small>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        {{ message }}
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<style>
.list-group-item.active {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.form-switch .form-check-input {
    height: 1.5em;
    width: 3em;
}

.form-switch .form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.avatar-upload input[type="file"] {
    cursor: pointer;
}

.avatar-preview {
    overflow: hidden;
    border: 3px solid #e9ecef;
}

.tab-content {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Toast positioning */
.toast {
    min-width: 300px;
    background: white;
}
</style>

<script>
// Tab functionality
document.addEventListener('DOMContentLoaded', function() {
    // Handle active tab from URL hash
    if (window.location.hash) {
        const activeTab = document.querySelector(`a[href="${window.location.hash}"]`);
        if (activeTab) {
            const tab = new bootstrap.Tab(activeTab);
            tab.show();

            // Update active state in list group
            document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(function(el) {
                el.classList.remove('active');
            });
            activeTab.classList.add('active');
        }
    }

    // Handle tab clicks
    const triggerTabList = [].slice.call(document.querySelectorAll('a[data-bs-toggle="tab"]'));
    triggerTabList.forEach(function (triggerEl) {
        triggerEl.addEventListener('click', function (event) {
            event.preventDefault();
            const tab = new bootstrap.Tab(triggerEl);
            tab.show();

            // Update URL hash
            history.pushState(null, null, triggerEl.getAttribute('href'));

            // Update active state in list group
            triggerTabList.forEach(function(el) {
                el.classList.remove('active');
            });
            triggerEl.classList.add('active');
        });
    });

    // Auto-hide toasts after 5 seconds
    setTimeout(function() {
        document.querySelectorAll('.toast').forEach(function(toast) {
            toast.classList.remove('show');
        });
    }, 5000);
});

// Image preview
function previewImage(input) {
    if (input.files && input.files[0]) {
        // Check file size (2MB limit)
        if (input.files[0].size > 2 * 1024 * 1024) {
            alert('File size must be less than 2MB');
            input.value = '';
            return;
        }

        // Check file type
        if (!input.files[0].type.match('image.*')) {
            alert('Please upload an image file (JPG, PNG, GIF)');
            input.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('profileImagePreview');

            if (preview) {
                if (preview.tagName === 'IMG') {
                    preview.src = e.target.result;
                } else {
                    // Replace div with img
                    const img = document.createElement('img');
                    img.id = 'profileImagePreview';
                    img.className = 'rounded-circle';
                    img.width = 100;
                    img.height = 100;
                    img.style.objectFit = 'cover';
                    img.style.border = '3px solid #fff';
                    img.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                    img.src = e.target.result;
                    img.alt = 'Profile picture';
                    preview.parentNode.replaceChild(img, preview);
                }
            }
        }
        reader.readAsDataURL(input.files[0]);
    }
}

// 2FA functions
function enable2FA() {
    if (confirm('Enable Two-Factor Authentication? This will add an extra layer of security to your account.')) {
        fetch('/api/settings/enable-2fa', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Failed to enable 2FA. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
    }
}

function disable2FA() {
    if (confirm('Disable Two-Factor Authentication? This will make your account less secure.')) {
        fetch('/api/settings/disable-2fa', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Failed to disable 2FA. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
    }
}

// View active sessions
function viewSessions() {
    fetch('/api/settings/sessions')
        .then(response => response.json())
        .then(data => {
            let sessionsHtml = '';
            if (data.sessions && data.sessions.length > 0) {
                sessionsHtml = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Device</th>
                                    <th>Location</th>
                                    <th>Last Active</th>
                                    <th>Current</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.sessions.forEach(session => {
                    sessionsHtml += `
                        <tr>
                            <td>${session.device || 'Unknown'}</td>
                            <td>${session.location || 'Unknown'}</td>
                            <td>${session.last_active ? new Date(session.last_active).toLocaleString() : 'Unknown'}</td>
                            <td>${session.is_current ? '<span class="badge bg-success">Current</span>' : '<span class="badge bg-secondary">Other</span>'}</td>
                            <td>
                                ${!session.is_current ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="terminateSession('${session.session_id}')">
                                    <i class="fas fa-sign-out-alt me-1"></i>Terminate
                                </button>
                                ` : '<span class="text-muted">Current session</span>'}
                            </td>
                        </tr>
                    `;
                });

                sessionsHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                sessionsHtml = '<p class="text-center text-muted py-4">No active sessions found.</p>';
            }

            document.getElementById('sessionsList').innerHTML = sessionsHtml;
            new bootstrap.Modal(document.getElementById('sessionsModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load sessions. Please try again.');
        });
}

function terminateSession(sessionId) {
    if (confirm('Terminate this session? The user will be logged out from that device.')) {
        fetch(`/api/settings/terminate-session/${sessionId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    viewSessions(); // Refresh the sessions list
                } else {
                    alert('Failed to terminate session. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
    }
}

function terminateAllSessions() {
    if (confirm('Terminate all other sessions? You will remain logged in on this device, but will be logged out from all other devices.')) {
        fetch('/api/settings/terminate-all-sessions', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('All other sessions have been terminated.');
                    location.reload();
                } else {
                    alert('Failed to terminate sessions. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
    }
}

// Data management functions
function exportData() {
    fetch('/api/settings/export-data')
        .then(response => response.json())
        .then(data => {
            if (data.url) {
                window.open(data.url, '_blank');
            } else {
                alert('Export initiated. Check your downloads folder.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to export data. Please try again.');
        });
}

function clearHistory() {
    if (confirm('Clear all diagnosis history? This action cannot be undone.')) {
        fetch('/api/settings/clear-history', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('History cleared successfully.');
                    // Optionally refresh the page or update UI
                } else {
                    alert('Failed to clear history. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
    }
}

// Danger zone functions
function deleteAccount() {
    const confirmation = prompt('Type "DELETE" to confirm account deletion:');
    if (confirmation === 'DELETE') {
        if (confirm('Are you absolutely sure? This will permanently delete your account and all associated data. This action cannot be undone.')) {
            fetch('/api/settings/delete-account', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/';
                    } else {
                        alert('Failed to delete account. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                });
        }
    } else if (confirmation !== null) {
        alert('Confirmation text did not match. Account deletion cancelled.');
    }
}

function resetSettings() {
    if (confirm('Reset all settings to default? This will revert all your preferences to factory defaults.')) {
        fetch('/api/settings/reset-settings', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Failed to reset settings. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
    }
}

function downloadAccountData() {
    fetch('/api/settings/download-data')
        .then(response => {
            if (response.ok) {
                return response.blob();
            }
            throw new Error('Network response was not ok.');
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `agriaid-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to download data. Please try again.');
        });
}

// Form submission handling
document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
            submitBtn.disabled = true;
        }
    });
});
</script>
{% endblock %}